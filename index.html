<!doctype html>
<html>
<head>
    <title>Procedural Graphics</title>
    <style>
        body {
            background: #112;
        }

        canvas {
            height: 100vh;
            left: 0;
            position: absolute;
            top: 0;
            width: 100vw;
        }

        select {
            position: absolute;
            top: 10px;
            right: 10px;
        }
    </style>
</head>
<body>
<canvas id="main"></canvas>
<script type="module">
    import {getControlState, initializeControls} from './src/controls.js';
    import {setPhysics, step} from './src/gameState.js';
    import {draw, setSize} from './src/view.js';
    import {getArrangement, getOptionsSelect} from './src/arrangements.js';
    import physics from './src/physics.js';

    const select = getOptionsSelect(reset);
    document.body.appendChild(select);

    setPhysics(physics);

    let graphicsContext;

    let gameState = {
        x: 0,
        y: 0,
        vx: 0,
        vy: 0,
        entities: getArrangement('default')
    }

    let controls = getControlState();

    function reset(newEntities) {
        console.log(newEntities)
        gameState = {
            x: 0,
            y: 0,
            vx: 0,
            vy: 0,
            entities: newEntities
        }
        showOneFrame(0);
    }

    function resizeGraphics() {
        const main = document.getElementById('main');
        main.width = main.clientWidth;
        main.height = main.clientHeight;
        graphicsContext = main.getContext('2d');

        setSize(main.clientWidth, main.clientHeight);
    }

    window.addEventListener('resize', resizeGraphics);


    let secondsSinceLastUpdate = 0;
    let previousTime = 0;

    function animationLoop(time) {
        secondsSinceLastUpdate = (time - previousTime) / 1000;
        previousTime = time;

        controls = getControlState();

        if (controls.pause) {
            showPaused(graphicsContext);
        } else {
            showOneFrame(secondsSinceLastUpdate);
        }
        requestAnimationFrame(animationLoop);
    }

    function showOneFrame(secondsSinceLastUpdate) {
        gameState = step(gameState, getControlState());
        draw(graphicsContext, secondsSinceLastUpdate, gameState);
    }

    initializeControls();
    resizeGraphics();
    showOneFrame(0);
    animationLoop();

    function showPaused(g) {
        g.fillStyle = 'white';
        g.fillRect(0, 0, 110, 40);
        g.font = '25px Arial';
        g.fillStyle = 'black';
        g.fillText("Paused", 10, 30);
    }

    window.addEventListener('keypress', e => {
        if (e.key === ' ' || e.key === 'n' || e.key === 's') {
            showOneFrame(.016);
        }
    })
</script>
</body>
</html>
